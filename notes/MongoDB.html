<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB 学习笔记 | Mark&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="个人博客">
    <meta name="keywords" content="前端博客,mark">
    <link rel="preload" href="/assets/css/0.styles.84987be6.css" as="style"><link rel="preload" href="/assets/js/app.3e4d0eed.js" as="script"><link rel="preload" href="/assets/js/2.68aca893.js" as="script"><link rel="preload" href="/assets/js/15.9c338a9c.js" as="script"><link rel="prefetch" href="/assets/js/10.a9ff179f.js"><link rel="prefetch" href="/assets/js/11.b7a3e839.js"><link rel="prefetch" href="/assets/js/12.87313dfa.js"><link rel="prefetch" href="/assets/js/13.1ce0f3e9.js"><link rel="prefetch" href="/assets/js/14.3be2a475.js"><link rel="prefetch" href="/assets/js/16.e329f9d4.js"><link rel="prefetch" href="/assets/js/17.e9295561.js"><link rel="prefetch" href="/assets/js/18.f1c319e0.js"><link rel="prefetch" href="/assets/js/19.da289b65.js"><link rel="prefetch" href="/assets/js/20.8a61d6bd.js"><link rel="prefetch" href="/assets/js/21.38e2dda9.js"><link rel="prefetch" href="/assets/js/22.38f90f15.js"><link rel="prefetch" href="/assets/js/23.c140781e.js"><link rel="prefetch" href="/assets/js/24.4bf67378.js"><link rel="prefetch" href="/assets/js/25.e62002b0.js"><link rel="prefetch" href="/assets/js/26.37c2aacd.js"><link rel="prefetch" href="/assets/js/27.36bcaeeb.js"><link rel="prefetch" href="/assets/js/3.d104a03d.js"><link rel="prefetch" href="/assets/js/4.a6f13a86.js"><link rel="prefetch" href="/assets/js/5.9038bd49.js"><link rel="prefetch" href="/assets/js/6.f0c06a32.js"><link rel="prefetch" href="/assets/js/7.d806bef0.js"><link rel="prefetch" href="/assets/js/8.0617fe87.js"><link rel="prefetch" href="/assets/js/9.ce94c0df.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84987be6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mark's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide.html" class="nav-link">
  导航
</a></li><li class="dropdown-item"><!----> <a href="/Notes.html" class="nav-link">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/Summaries.html" class="nav-link">
  总结
</a></li><li class="dropdown-item"><!----> <a href="/Articles.html" class="nav-link">
  文章
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/Galileo01" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide.html" class="nav-link">
  导航
</a></li><li class="dropdown-item"><!----> <a href="/Notes.html" class="nav-link">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/Summaries.html" class="nav-link">
  总结
</a></li><li class="dropdown-item"><!----> <a href="/Articles.html" class="nav-link">
  文章
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/Galileo01" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MongoDB 学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/MongoDB.html#mongodb" class="sidebar-link">MongoDB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#一-三个重要概念" class="sidebar-link">一.三个重要概念</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#二-基本指令" class="sidebar-link">二.基本指令</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#crud-操作" class="sidebar-link">CRUD 操作</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#小知识点1" class="sidebar-link">小知识点1</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#小知识点2" class="sidebar-link">小知识点2</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#文档之间的关系" class="sidebar-link">文档之间的关系</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#小知识点3" class="sidebar-link">小知识点3</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#sort和投影" class="sidebar-link">sort和投影</a></li></ul></li><li><a href="/notes/MongoDB.html#mongoose" class="sidebar-link">Mongoose</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#schema" class="sidebar-link">Schema</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#model" class="sidebar-link">Model</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#document" class="sidebar-link">Document</a></li><li class="sidebar-sub-header"><a href="/notes/MongoDB.html#mongoose-的模块化" class="sidebar-link">Mongoose 的模块化</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongodb-学习笔记"><a href="#mongodb-学习笔记" class="header-anchor">#</a> MongoDB 学习笔记</h1> <p>一种文档型的 <strong>NoSQL</strong> 数据库</p> <p>是非关系数据库当中功能<strong>最丰富，最像关系数据库的</strong>。支持部分SQL语句</p> <ul><li><p>mongoDB 将数据存储为一个文档，数据结构由键值(key=&gt;value)对组成。存储在<strong>BSON</strong>（binary  json ）。字段值可以包含其他文档，数组及文档数组。</p></li> <li><p>为 快速开发Web 应用而设计</p></li> <li><p>极简，灵活</p></li> <li><p>数据模型是面向文档的，</p></li></ul> <h2 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h2> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <h4 id="windows下的安装"><a href="#windows下的安装" class="header-anchor">#</a> windows下的安装</h4> <p>下载，安装   https://www.mongodb.com/try/download/community</p> <h4 id="linux下安装"><a href="#linux下安装" class="header-anchor">#</a> linux下安装</h4> <ul><li><p>下载tgz文件</p></li> <li><p>通过scp 指令上传到服务器</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">scp</span>  xxx.tgz admin@121.41.225.12:/usr/local/MongoDB
</code></pre></div></li> <li><p>解压</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tar</span> -zxvf xxx.tgz -C /usr/local/MongoDB
</code></pre></div></li> <li><p>创建文件夹</p> <p>创建db文件夹 存放数据库数据，</p> <p>创建log文件夹，存放输出日志</p></li> <li><p>创建配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 端口</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">27017</span>
<span class="token comment">#数据目录</span>
dbpath <span class="token operator">=</span> /usr/local/MongoDB/data/db
<span class="token comment">#日志文件</span>
logpath <span class="token operator">=</span> /usr/local/MongoDB/data/log/mongodb.log
<span class="token comment">#设置后台运行</span>
fork <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">#日志输出方式</span>
logappend <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div></li> <li><p>应用配置并进入数据库</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># bin目录下</span>
<span class="token function">sudo</span> ./mongod --config ./mongodb.conf
./mongo 进入数据库前台命令行
mongo --username admin --password <span class="token number">15823413506</span>  <span class="token comment">#有用户验证的情况下连接数据库</span>
<span class="token comment">#--config 缩写成-f</span>
</code></pre></div></li> <li><p>配置$PATH（推荐，非必须）</p> <p>将bin下的可执行文件 添加到 PATH ，这样就可以在<strong>任意目录下 使用</strong>bin/下的命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/mongodb4/bin:<span class="token environment constant">$PATH</span>
</code></pre></div><p>这个方法重启后$PATH 的设置就失效了，</p> <p>还有种永久的方法就是  <strong>把bin下的 可执行文件 复制到 /user/local/bin 或者其他 $PATH 下的目录</strong></p></li> <li><p>设置一个账户，授权使用数据库，更加安全（最好设置，不是必须的步骤）</p> <div class="language-shell extra-class"><pre class="language-shell"><code>use admin <span class="token comment">#切换到admin</span>

db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;admin&quot;</span>,pwd:<span class="token string">&quot;158...&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db.auth<span class="token punctuation">(</span><span class="token string">'root'</span>,<span class="token string">'123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 使用 账户登录</span>
db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">#关闭</span>
</code></pre></div><p>conf 配置文件新增  以下字段</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#开启身份验证</span>
auth <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><p>验证账户的方式进入数据库</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mongo <span class="token number">127.0</span>.0.1:27017/admin --username <span class="token string">&quot;root&quot;</span> --password <span class="token string">&quot;123456&quot;</span>
</code></pre></div></li> <li><p>可能遇到的问题</p> <ul><li><p>关闭mongod 方法：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>use admin
db.shutdownServer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>mongod自带的问题修复工具</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mongod --repair
</code></pre></div></li></ul></li></ul> <p>非正常关闭mongdb 会在db文件下生成 <strong>mongod.lock</strong>文件，必须删除这个 文件，否则后面启动会报错</p> <ul><li><p><strong>如果要使用navicat 等数据库管理工具远程</strong> 连接linux的mongodb 要在conf 配置文件 添加以下</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">bind_ip</span><span class="token operator">=</span> <span class="token number">0.0</span>.0.0 
<span class="token comment">#因为bind_ip 默认 是127.0.0.1，只允许本地IP连接mongodb数据库，改成0.0.0.0 允许任何ip 连接</span>
</code></pre></div></li></ul> <h4 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h4> <ul><li><p>服务器</p> <ul><li><p>保存数据</p></li> <li><p><strong>mongod</strong>  命令启动服务器</p> <p>命令行   mongod</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mongod --dbpath D:<span class="token punctuation">\</span><span class="token punctuation">..</span>.  --port <span class="token number">129</span><span class="token comment"># 将D盘某目录设置为数据库目录   指定129为数据库端口</span>
</code></pre></div><p>mongoDB默认 在 <strong>27017端口</strong></p></li></ul></li> <li><p>客户端</p> <ul><li>用来操作数据库</li> <li><strong>mongo</strong> 启动客户端</li></ul></li></ul> <p>， 进入一个 mongo shell  ，也是一个ES shell 支持  js代码</p> <h3 id="一-三个重要概念"><a href="#一-三个重要概念" class="header-anchor">#</a> 一.三个重要概念</h3> <img src="https://cdn.jsdelivr.net/gh/Galileo01/imgCloud@master/image-20200804154707582.png" alt="image-20200804154707582" style="zoom:67%;"> <ul><li><p>mongoDB 中 数据库和集合  <strong>不需要我们手动创建</strong></p> <p><strong>创建文档时</strong>，文档所在集合/数据库不存在，<strong>会自动创建</strong></p></li></ul> <h3 id="二-基本指令"><a href="#二-基本指令" class="header-anchor">#</a> 二.基本指令</h3> <ul><li><p>show dbs/show databases</p> <p>列出所有数据库</p></li> <li><p>use databaseName</p> <p>切换到具体数据库</p></li> <li><p>db</p> <p>显示当前所在数据库名</p></li> <li><p>show collections</p> <p>列出当前数据库所有集合</p></li></ul> <h3 id="crud-操作"><a href="#crud-操作" class="header-anchor">#</a> CRUD 操作</h3> <h5 id="_1-插入，增加-文档"><a href="#_1-插入，增加-文档" class="header-anchor">#</a> 1.插入，增加 文档</h5> <ul><li><p>db.<collectionName>.insert(doc)   向集合插入一个或多个文档</collectionName></p></li> <li><p>db.<collectionName>.insertOne(doc)  单个</collectionName></p></li> <li><p>db.<collectionName>.insertMany(doc)    插入多个文档，必须传入数组</collectionName></p></li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>db.stus.insert<span class="token punctuation">(</span><span class="token punctuation">{</span>name:<span class="token string">&quot;sunwukong&quot;</span>,age:19<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">## 此时会创建test 数据库，stus 集合</span>
db.stus.insert<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>name:<span class="token string">&quot;sunwukong&quot;</span>,age:19<span class="token punctuation">}</span>,<span class="token punctuation">{</span>name:<span class="token string">&quot;zhubajie&quot;</span>,age:19<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
db.stus.find<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">## 列出集合 内的文档</span>
</code></pre></div><p>当向集合插入文档时没有指定_id 属性，会自动添加 _ id 属性，作为<strong>唯一标识</strong></p> <p>自己指定必须确保唯一性，</p> <div class="language- extra-class"><pre><code>使用 可在shell  用 ObjectId() 命令 生成
</code></pre></div><h5 id="_2-查询"><a href="#_2-查询" class="header-anchor">#</a> 2.  查询</h5> <p>更多查询方式见官方 <a href="https://docs.mongodb.com/manual/tutorial/query-documents/" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li><p>db.stus.find({<key>：<value>})   返回一个数组   <strong>可以索引取值 [0]</strong></value></key></p> <p>查询<strong>所有</strong>符合条件的 文档，<strong>不传参数 返回集合下的所有文档</strong></p> <ul><li>find().count()/length() 返回符合条件的个数</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>db.stus.find<span class="token punctuation">(</span><span class="token punctuation">{</span>age:19<span class="token punctuation">}</span><span class="token punctuation">)</span>  
db.stus.find<span class="token punctuation">(</span><span class="token punctuation">{</span>obj:<span class="token punctuation">{</span>type:<span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">#多层嵌套</span>
db.stus.find<span class="token punctuation">(</span><span class="token punctuation">{</span>age:19<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
db.stus.find<span class="token punctuation">(</span><span class="token punctuation">{</span>age:19<span class="token punctuation">}</span><span class="token punctuation">)</span>.count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p><strong>查询嵌套的域</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>db.inventory.find<span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token string">&quot;obj.type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;test&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token comment">#查询 obj 字段下，type 字段为&quot;test&quot;的</span>
</code></pre></div></li></ul></li> <li><p>db.stus,findOne({})    返回一个<strong>文档对象</strong></p> <p>查询第一个符合条件的文档对象</p> <div class="language-shell extra-class"><pre class="language-shell"><code>db.stus.findOne<span class="token punctuation">(</span><span class="token punctuation">{</span>age:20<span class="token punctuation">}</span><span class="token punctuation">)</span>.age
</code></pre></div><h5 id="使用-query-operator-查询操作符（sql数据库中的where-）"><a href="#使用-query-operator-查询操作符（sql数据库中的where-）" class="header-anchor">#</a> 使用 Query Operator 查询操作符（SQL数据库中的where ）</h5></li></ul> <table><thead><tr><th>等于</th> <th>{<key>:<value>}</value></key></th> <th>db.col.find({&quot;by&quot;:&quot;菜鸟教程&quot;})</th></tr></thead> <tbody><tr><td>小于</td> <td><code>{&lt;key&gt;:{$lt:&lt;value&gt;}}</code></td> <td><code>db.col.find({&quot;likes&quot;:{$lt:50}})</code></td></tr> <tr><td>小于或等于</td> <td><code>{&lt;key&gt;:{$lte:&lt;value&gt;}}</code></td> <td>db.col.find({&quot;likes&quot;:{$lte:50}})</td></tr> <tr><td>大于</td> <td><code>{&lt;key&gt;:{$gt:&lt;value&gt;}}</code></td> <td><code>db.col.find({&quot;likes&quot;:{$gt:50}})</code></td></tr> <tr><td>大于或等于</td> <td><code>{&lt;key&gt;:{$gte:&lt;value&gt;}}</code></td> <td><code>db.col.find({&quot;likes&quot;:{$gte:50}})</code></td></tr> <tr><td>不等于</td> <td><code>{&lt;key&gt;:{$ne:&lt;value&gt;}}</code></td> <td><code>db.col.find({&quot;likes&quot;:{$ne:50}})</code></td></tr></tbody></table> <p>find().pretty()  使得查询出来的数据在命令行中更加美观的显示</p> <p>同时使用多个操作符</p> <div class="language-shell extra-class"><pre class="language-shell"><code>db.stus.find<span class="token punctuation">(</span><span class="token punctuation">{</span>age:<span class="token punctuation">{</span><span class="token variable">$gt</span>:19,<span class="token variable">$lt</span>:21<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="支持正则表达式"><a href="#支持正则表达式" class="header-anchor">#</a> 支持正则表达式</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>db.col.find<span class="token punctuation">(</span><span class="token punctuation">{</span>title:/教/<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 查询 title 字段以&quot;教&quot;字开头的文档：</span>

db.col.find<span class="token punctuation">(</span><span class="token punctuation">{</span>title:/^教/<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 查询 titl e字段以&quot;教&quot;字结尾的文档：</span>

<span class="token comment">#db.col.find({title:/教$/})</span>
</code></pre></div><ul><li><p>查询数组</p> <p>使用操作符</p> <p>{ <array field="">: { <operator1>: <value1>, ... } }</value1></operator1></array></p> <div class="language-shell extra-class"><pre class="language-shell"><code>db.inventory.find<span class="token punctuation">(</span> <span class="token punctuation">{</span> tags: <span class="token punctuation">[</span><span class="token string">&quot;red&quot;</span>, <span class="token string">&quot;blank&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token comment">#查询只包含“red”“blank” 的tags 数组,且顺序固定</span>
db.inventory.find<span class="token punctuation">(</span> <span class="token punctuation">{</span> tags: <span class="token punctuation">{</span> <span class="token variable">$all</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">&quot;red&quot;</span>, <span class="token string">&quot;blank&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token comment">#查询 包含red，blank 的，顺序不定</span>
db.inventory.find<span class="token punctuation">(</span> <span class="token punctuation">{</span> tags: <span class="token string">&quot;red&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> <span class="token comment">#对于tags 是一个数组来说，查询包含 red的</span>
db.inventory.find<span class="token punctuation">(</span> <span class="token punctuation">{</span> numbers: <span class="token punctuation">{</span> <span class="token variable">$gt</span><span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>  <span class="token comment">#查询 包含大于25 数字的numbers 所在文档</span>
</code></pre></div></li></ul> <h5 id="_3-修改"><a href="#_3-修改" class="header-anchor">#</a> 3. 修改</h5> <ul><li><p>db.collection.<strong>update</strong>(<filter>,<update> ,<options> )</options></update></filter></p> <p>默认会使用新对象<update><strong>替换</strong>旧对象，使用操作符$set可解决</update></p> <p><strong><update> 形式:</update></strong></p> <div class="language-js extra-class"><pre class="language-js"><code></code></pre></div></li></ul> <p>{
<update operator="">: { <field1>: <value1>, ... },
<update operator="">: { <field2>: <value2>, ... },
}</value2></field2></update></value1></field1></update></p> <div class="language- extra-class"><pre class="language-text"><code>

**默认 只更新第一个匹配的文档**，行为和updateOne 一致

更新多个文档需要传入**options**参数

```shell
db.stus.update({age:19},{$set:{height:500}},{multi:true}) # multi 表示 修改多个文档
</code></pre></div><ul><li><p>db.collection.updateOne(<filter>,<update> ,<options> )</options></update></filter></p></li> <li><p>db.collection.updateMany(<filter>,<update> ,<options>  )</options></update></filter></p></li> <li><p>db.collection.replaceOne(<filter>,<update> ,<options>  ) 替换</options></update></filter></p></li> <li><p><a href="https://docs.mongodb.com/manual/reference/operator/update" target="_blank" rel="noopener noreferrer">修改操作符（ update operators）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>常用</p> <ul><li><p>$set</p> <p>只设置 对应的属性</p> <p>文档没有的属性就新建</p></li> <li><p>$unset</p> <p>移除某个属性</p> <div class="language-shell extra-class"><pre class="language-shell"><code>db.inventory.updateOne<span class="token punctuation">(</span>
   <span class="token punctuation">{</span> item: <span class="token string">&quot;paper&quot;</span> <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span>
     <span class="token variable">$set</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;size.uom&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;cm&quot;</span>, status: <span class="token string">&quot;P&quot;</span> <span class="token punctuation">}</span>,<span class="token comment">#更新 size.uom， status</span>
     <span class="token variable">$unset</span>:<span class="token punctuation">{</span>adress:<span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>,  <span class="token comment">#移除address 属性</span>
     <span class="token variable">$currentDate</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> lastModified: <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token comment"># 当前时间</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>$inc</p> <p>自增操作符</p></li></ul> <p>数组更新操作符</p> <div class="language- extra-class"><pre><code> - $push

   数组末尾追加元素
</code></pre></div><ul><li><p>$addToSet</p> <p>追加，同时保证<strong>元素不重复</strong></p></li></ul></li></ul> <h5 id="_4-删除文档"><a href="#_4-删除文档" class="header-anchor">#</a> 4.删除文档</h5> <ul><li><p>db.collection.remove(<filter> ,<options>)</options></filter></p> <p>删除所有 符合条件的文档，</p> <p>只删除一个使用deleteOne或者 传入options参数   true /{justOne：true}</p> <div class="language-shell extra-class"><pre class="language-shell"><code>db.collection.remove<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 删除所有文档，清空集合，但性能较差 不推荐</span>
do.collection.drop<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#删除集合 ，推荐</span>
</code></pre></div></li> <li><p>db.collection.deleteOne()</p></li> <li><p>db.collection.deleteMany()</p></li> <li><p>db.dropDatabase() 删除数据库</p></li></ul> <h3 id="小知识点1"><a href="#小知识点1" class="header-anchor">#</a> 小知识点1</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 的属性值也可以是一个文档（与JSON一致）</span>
<span class="token comment"># 这种文档内部的文档叫内嵌文档</span>
db.users.update<span class="token punctuation">(</span><span class="token punctuation">{</span>username:<span class="token string">&quot;sunwukong&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$set</span>:<span class="token punctuation">{</span>hobby:<span class="token punctuation">{</span>cities:  <span class="token punctuation">[</span><span class="token string">&quot;beijing&quot;</span>,<span class="token string">&quot;shanghai&quot;</span>,<span class="token string">&quot;shenzhen&quot;</span><span class="token punctuation">]</span> , movies:<span class="token punctuation">[</span><span class="token string">&quot;sanguo&quot;</span>,<span class="token string">&quot;hero&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 如果要通过内嵌文档来对文档进行查询，此时属性名   必须使用引号 </span>
db.users.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'hobby.movies'</span><span class="token builtin class-name">:</span><span class="token string">&quot;hero&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment"># 表示 查询hobby.movies 数组包含&quot;hero&quot; 的文档</span>

<span class="token comment"># 向tangseng中添加一个新的电影Interstellar</span>
db.users.update<span class="token punctuation">(</span><span class="token punctuation">{</span>username:<span class="token string">&quot;tangseng&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$push</span>:<span class="token punctuation">{</span><span class="token string">&quot;hobby.movies&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Interstellar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
db.users.update<span class="token punctuation">(</span><span class="token punctuation">{</span>username:<span class="token string">&quot;tangseng&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$addToSet</span>:<span class="token punctuation">{</span><span class="token string">&quot;hobby.movies&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Interstellar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># Set 元素不重复</span>

<span class="token comment"># $each 一次添加多个</span>
db.users.update<span class="token punctuation">(</span><span class="token punctuation">{</span>name:<span class="token string">&quot;xiaoming&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token variable">$push</span>:<span class="token punctuation">{</span><span class="token string">&quot;hobby.movies&quot;</span>:<span class="token punctuation">{</span><span class="token variable">$each</span>:<span class="token punctuation">[</span><span class="token string">&quot;11&quot;</span>,<span class="token string">&quot;12&quot;</span>,<span class="token string">&quot;13&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment"># //17.向numbers中插入20000条数据 7.2s</span>
for<span class="token punctuation">(</span>let  <span class="token assign-left variable">i</span><span class="token operator">==</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">20000</span> <span class="token punctuation">;</span> i++<span class="token punctuation">)</span><span class="token punctuation">{</span>
    db.numbers.insert<span class="token punctuation">(</span><span class="token punctuation">{</span>num:i<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">#执行了20000 次</span>
<span class="token punctuation">}</span>
<span class="token comment"># 只调用一次</span>
<span class="token builtin class-name">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

for<span class="token punctuation">(</span>let <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token operator">=</span><span class="token number">20000</span> <span class="token punctuation">;</span> i++<span class="token punctuation">)</span><span class="token punctuation">{</span>
    arr.push<span class="token punctuation">(</span><span class="token punctuation">{</span>num:i<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

db.numbers.insert<span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="小知识点2"><a href="#小知识点2" class="header-anchor">#</a> 小知识点2</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 前十条文档</span>
<span class="token comment"># limit(limit) </span>
db.numbers.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">#常用于  分页</span>
<span class="token comment"># 11-20条</span>
<span class="token comment"># skip(&lt;offset&gt;) 跳过offset 的数据</span>
<span class="token comment"># skip((pagenum-1)*pagesize).limit(pagesize) </span>
db.numbers.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.skip<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>.limit<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment"># skip 和limit 相对位置交换，结果一致，</span>

const <span class="token assign-left variable">num</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> db.numbers.find<span class="token punctuation">(</span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment"># 支持ES语法</span>

<span class="token comment">#   查询 sal 小于1000  或者 sal 大于2500     $or 操作符</span>
db.emp.find<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token variable">$or</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        sal: <span class="token punctuation">{</span>
            <span class="token variable">$lt</span><span class="token builtin class-name">:</span> <span class="token number">1000</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>, <span class="token punctuation">{</span>
        sal: <span class="token punctuation">{</span>
            <span class="token variable">$gt</span><span class="token builtin class-name">:</span> <span class="token number">2500</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="文档之间的关系"><a href="#文档之间的关系" class="header-anchor">#</a> 文档之间的关系</h3> <ol><li>1对1</li></ol> <ul><li>在MongoDB 中 ，通过内嵌文档 体现</li></ul> <ol start="2"><li>1对N/N对1</li></ol> <ul><li>内嵌文档，数组</li> <li>在文档属性内使用其他文档的_id</li></ul> <ol start="3"><li>N对N</li></ol> <ul><li>内嵌文档，数组</li> <li>在文档属性内使用其他文档的_id 数组</li></ul> <h3 id="小知识点3"><a href="#小知识点3" class="header-anchor">#</a> 小知识点3</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>
<span class="token comment"># $or 操作符</span>
<span class="token comment"># $or:[{},{},{}]</span>
<span class="token comment">#  查询 sal 小于1000  或则 sal 大于2500</span>
db.emp.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token variable">$or</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span>sal:<span class="token punctuation">{</span><span class="token variable">$lt</span>:1000<span class="token punctuation">}</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>sal:<span class="token punctuation">{</span><span class="token variable">$gt</span>:2500<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 查询销售部员工</span>
var depno <span class="token operator">=</span> db.dept.findOne<span class="token punctuation">(</span><span class="token punctuation">{</span>
    dname: <span class="token string">&quot;销售部&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>.deptno

db.emp.find<span class="token punctuation">(</span><span class="token punctuation">{</span>
    depno
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">#33.为所有薪资低于1000的员工增加工资400元</span>

</code></pre></div><h3 id="sort和投影"><a href="#sort和投影" class="header-anchor">#</a> sort和投影</h3> <p><strong>查询文档时，默认时按照_id升序排序</strong></p> <ul><li><p>sort( { age : -1 } ) 函数</p> <p>指定排序规则</p> <p>1:升序，-1降序</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>sort( { age : -1, posts: 1 } ) # 先按照 age 降序排序，age 相同的按照 posts 升序
</code></pre></div><p>skip，limit，sort 三者 无论相对位置，最后都是 sort-&gt;skpi-&gt;limit</p> <ul><li><p>find 函数 的 投影</p> <p>fdb.collection.find(query, <strong>projection</strong>) ，可以传递第二个参数用来 设置结果的某些字段不显示</p></li></ul> <p><field>: &lt;1 or true&gt;	显示
<field>: &lt;0 or false&gt;   不显示</field></field></p> <p><strong>_id 默认显示，</strong></p> <h2 id="mongoose"><a href="#mongoose" class="header-anchor">#</a> Mongoose</h2> <p>​       mongoose 是一个让我们可以通过<strong>Node来操作MongoDB的模块。</strong>
​       Mongoose是一 个<strong>对象文档模型( ODM)库</strong>(把文档转换为js 对象，易于操作),它对Node原生的<strong>MongoDB模块</strong>进行了进-步的优化封装,并提供了更多的功能。
​      在大多数情况下,它被用来把结构化的模式应用到一一个MongoDB集合,<strong>并提供了验证和类型转换</strong>等好处</p> <ul><li><p>优点</p> <ul><li><p>可以为文档创建一个<strong>模式结构（Schema）</strong>/或者叫做一种类似于SQL 数据库的约束</p></li> <li><p>可以对模型中的对象/文档进行<strong>验证</strong></p></li> <li><p>数据可以通过类型转换转换为对象模型</p></li> <li><p>可以使用<strong>中间件</strong>来应用业务逻辑挂钩</p></li> <li><p>比Node原生的MongoDB驱动更容易</p></li></ul></li> <li><p>mongoose中为我们提供了几个新的对象</p> <ul><li><strong>Schema</strong>(模式对象)</li></ul> <p>​       Schema对象定义约束了数据库中的文档结构</p> <ul><li><strong>Model</strong> （对应MongoDB的 集合<strong>collections</strong>）</li></ul> <p>​       Model对象作为集合中的所有文档的表示，<strong>相当于 MongoDB数据库中的集合collection</strong></p> <ul><li><strong>Document</strong></li></ul> <p>​      Document表示集合中的具体<strong>文档</strong>，相当于集合中 的一个<strong>具体的文档</strong></p></li></ul> <p>创建顺序   ：<strong>Schema</strong>- &gt;<strong>Model</strong>-&gt;<strong>Document</strong></p> <h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <h4 id="安装-2"><a href="#安装-2" class="header-anchor">#</a> 安装</h4> <h4 id="引入"><a href="#引入" class="header-anchor">#</a> 引入</h4> <h4 id="连接"><a href="#连接" class="header-anchor">#</a> 连接</h4> <ul><li><strong>mongoose.connect 方法</strong></li></ul> <p>mongoose.connect('<strong>mongodb</strong>😕/ip:端口/数据库名')</p> <div class="language-js extra-class"><pre class="language-js"><code>mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/test'</span>，<span class="token punctuation">{</span> useUnifiedTopology<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>useNewUrlParser<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//注：如果linux/windows的mongodb 设置了用户验证，需要在连接时输入用户名密码</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://username:pass@127.0.0.1/crud?authSource=admin'</span><span class="token punctuation">,</span><span class="token punctuation">{</span> useUnifiedTopology<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>useNewUrlParser<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//authSource=admin 参数规定 用于验证的用户来自 admin 数据库</span>
</code></pre></div><p>经测试，可以连接远程的 mongodb 数据库，前提是 相应的端口开放</p> <p>端口号若是27017，可省</p> <ul><li><p>监听数据库连接状态</p> <p>mongoose 对象的connection 属性，可以绑定事件</p> <p>比如，可以通过<strong>open</strong>和**close **事件来监控连接 的打开和关闭。</p></li> <li><p>断开连接</p> <p>mongoose.disconnect() 一般不使用</p></li> <li><p>操作数据库</p> <ul><li><p>创建 <strong>模式对象 Schema</strong>  ,修饰文档结构</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stuSchema<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span>String<span class="token punctuation">,</span>
    age<span class="token operator">:</span>Number<span class="token punctuation">,</span>
    address<span class="token operator">:</span>String<span class="token punctuation">,</span>
    gender<span class="token operator">:</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span>Number<span class="token punctuation">,</span>
            <span class="token keyword">default</span><span class="token operator">:</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>创建Model  对象（<em>创建集合</em>）或者 Document 对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//mongoose.model(modelName, schema)  </span>
<span class="token comment">//modelName =集合名  ，会被转换为复数</span>
<span class="token keyword">const</span> StuModel<span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'studs'</span><span class="token punctuation">,</span>stuSchema<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回一个构造函数</span>
</code></pre></div></li> <li><p>操作</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">//创建并插入文档</span>
StuModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span><span class="token string">&quot;baikujing&quot;</span><span class="token punctuation">,</span>
        age<span class="token operator">:</span><span class="token string">'100'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'插入成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ul> <p>mongoose 所有api 方法都返回 promise</p> <h3 id="schema"><a href="#schema" class="header-anchor">#</a> Schema</h3> <p>MongoBD 本身很灵活，不需要设计结构</p> <p>但是<strong>还是需要一定程度上</strong> 的 字段<strong>约束</strong>，保证 数据添加的 正确性，</p> <p>使用<strong>Schema</strong> 模式结构对象，对文档的属性 字段进行描述，约束，  这样mongoose 还可以帮助我们<strong>进行验证</strong>和<strong>类型转换</strong></p> <h3 id="model"><a href="#model" class="header-anchor">#</a> Model</h3> <p>Model 类 对应 集合，通过Model 操作数据库，也就是db.<collection>操作数据库</collection></p> <p>mongoose.model('studs',stuSchema);方法返回一个 <strong>构造函数</strong>，<strong>new 构造出的就是 Document 实例</strong></p> <p>以下可以称作    <strong>Model 类</strong>的 <strong>静态方法</strong>，</p> <h4 id="增"><a href="#增" class="header-anchor">#</a> 增</h4> <ul><li><p>Model.create(doc(s),[options],[callback])</p> <ul><li><p>doc(s):   <strong>Array/Object</strong></p></li> <li><p>options: 传递给 中间件 **save（）**方法的参数</p></li> <li><p>callback：（err,doc(s)）/(错误对象，插入的内容)</p></li> <li><p>return :Promise</p> <p>mongose 绝大部分方法 返回Promise ，可以使用<strong>then</strong> ，或者 <strong>await</strong></p></li></ul></li></ul> <h4 id="查"><a href="#查" class="header-anchor">#</a> 查</h4> <ul><li><p>Model.find(filter ,[projection] ,[options],[callback])</p> <ul><li><p>filter :查询条件</p></li> <li><p>projection ：投影对象或字段**字符串，**决定结果要显示的字段</p></li> <li><p>options: 查询选项，skip，limit，sort 等</p></li> <li><p><strong>callback</strong> ：（err,docs） <strong>docs</strong> 始终为数组</p> <p><strong>回调函数必传或者使用then（await ）接收返回数据，否则不会查询</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//projection 参数</span>
<span class="token comment">//1. 使用mongodb 的对象形式</span>

StuModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>_id<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">docs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//2. 使用字符串</span>
StuModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'name age -_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">docs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment">// -_id  不显示_id</span>

<span class="token comment">//options 查询选项 参数</span>
StuModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'name age -_id'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>skip<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>limit<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>sort<span class="token operator">:</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">docs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">// 使用 then 处理 promise</span>
StuModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">docs</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <p>})</p> <div class="language- extra-class"><pre class="language-text"><code>


</code></pre></div></li> <li><p>Model.findOne(filter ,[projection] ,[options],[callback])</p> <p>查询第一个返祖filter 的<strong>文档对象</strong>，</p> <p>callback： (err,<strong>doc</strong>)   doc单个文档对象</p> <p>doc 是 <strong>Model 构造方法 构造出的实例</strong></p></li> <li><p>Model.findByID(id,[projection] ,[options],[callback])</p> <p>callback： (err,<strong>doc</strong>)    <strong>doc单个文档对象</strong>、</p></li></ul> <h4 id="改"><a href="#改" class="header-anchor">#</a> 改</h4> <ul><li><p>Model.update(filter ,doc,[options],[callback])</p> <ul><li><p>options:  选项，multi 等</p></li> <li><p>callback 😦 error, <strong>updateWriteOpResult</strong>)</p> <p><strong>updateWriteOpResult</strong>:原生 mongoDB 返回的操作结果</p> <p><strong>回调函数必传或者使用then（await ）接收返回数据，否则不会更新</strong></p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>StuModel<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">'zhubajie'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>$<span class="token keyword">set</span><span class="token operator">:</span><span class="token punctuation">{</span>age<span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>multi<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p><strong>updateWriteOpResult</strong>：</p> <p>属性</p> <ul><li>n:匹配到的个数</li> <li>nModified:更改个数</li> <li>ok:更新是否成功</li></ul></li> <li><p>Model.updateMany(filter ,doc,[options],[callback])</p></li> <li><p>Model.updateOne(filter ,doc,[options],[callback])</p></li> <li><p>Model.replaceOne(filter ,doc,[options],[callback])</p></li></ul> <h4 id="删"><a href="#删" class="header-anchor">#</a> 删</h4> <ul><li><p>Model.remove(filter ,[options],[callback])</p> <ul><li><p>options</p></li> <li><p>callback</p> <p><strong>回调函数必传或者使用then（await ）接收返回数据，否则不会更新</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>StuModel<span class="token punctuation">.</span><span class="token function">deleteOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">&quot;666&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li> <li><p>Model.deleteOne(filter ,[options],[callback])</p></li> <li><p>Model.deleteMany(filter ,[options],[callback])</p></li></ul> <h4 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h4> <ul><li><p>Model.count(filter,[callback])</p> <p>统计 个数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 统计所有个数</span>
StuModel<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>count</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
StuModel<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>count</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <p>将在下一个版本移除，推荐使用countDocuments 方法代替  in v 5.927</p> <h3 id="document"><a href="#document" class="header-anchor">#</a> Document</h3> <p>Document 是Model 构造的 实例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//创建 Document 实例</span>
<span class="token keyword">const</span> stu<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StuModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span><span class="token string">&quot;小米&quot;</span><span class="token punctuation">,</span>
        age<span class="token operator">:</span><span class="token number">20</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>​		<strong>实例方法</strong></p> <ul><li><p>doc.save([options],callback)</p> <p>将文档保存到集合</p> <ul><li>callback :(err,<strong>updateWriteOpResult</strong>)</li></ul></li> <li><p>doc.update(update,[options],<strong>callback</strong>)</p> <ul><li><p>update</p></li> <li><p>callback : (err)</p> <p><strong>回调函数必传或者使用then（await ）接收返回数据，否则不会更新</strong></p></li></ul></li></ul> <p>将要弃用 ，推荐 document.updateOne/updateMany 代替  in  v 5.927</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建一个 docuemnt 对象</span>
<span class="token keyword">const</span> stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StuModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">&quot;小米&quot;</span><span class="token punctuation">,</span>
        age<span class="token operator">:</span> <span class="token number">20</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">await</span> stu<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StuModel<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;小米&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> res<span class="token punctuation">;</span>
                 doc<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> $<span class="token keyword">set</span><span class="token operator">:</span> <span class="token punctuation">{</span> age<span class="token operator">:</span> <span class="token number">777</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// console.log(res);</span>
            
                <span class="token comment">//第二种方法</span>
                doc<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token string">&quot;武汉小米&quot;</span><span class="token punctuation">;</span>
                res <span class="token operator">=</span> <span class="token keyword">await</span> doc<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// console.log(res);</span>
            <span class="token comment">//删除</span>
                res <span class="token operator">=</span> <span class="token keyword">await</span> doc<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// console.log(res);</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>doc.remove([callback])</p></li> <li><p>doc.get(feild)</p></li> <li><p>doc.set(feild,value)</p></li> <li><p>doc.toJSON([options])</p> <p>转换为JSON对象</p> <ul><li><a href="https://mongoosejs.com/docs/api/document.html#document_Document-toObject" target="_blank" rel="noopener noreferrer">options<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 选项参数</li></ul></li> <li><p>doc.toObject([options])</p></li></ul> <p>​     返回 <strong>js 普通对象</strong>，返回的对象  <strong>没有Document 的实例属性和方法</strong></p> <p>​        options 和toJSON方法一致</p> <ul><li><p>doc.id属性</p> <p>documents._id 的字符串形式，</p> <p>使用filter 进行查找时，_id可以传入字符串，而，<strong>document 之间的比较</strong>   需要使用  .id属性，进行字符串的比较，因为 <strong>对象形式</strong>的ObjectId()是一个引用，始终不相等，</p></li></ul> <h3 id="mongoose-的模块化"><a href="#mongoose-的模块化" class="header-anchor">#</a> Mongoose 的模块化</h3> <p>抽离模块</p> <ul><li><p>连接模块</p> <p>专门用于和数据库进行连接</p></li> <li><p>模型对象模块</p> <p>抽象出不同的Model 对象，并导出，在路由内调用，操作数据库</p></li></ul> <p>放置在不同文件夹</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/27/2020, 12:37:33 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.3e4d0eed.js" defer></script><script src="/assets/js/2.68aca893.js" defer></script><script src="/assets/js/15.9c338a9c.js" defer></script>
  </body>
</html>
